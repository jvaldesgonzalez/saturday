<input type="file" id="selector" multiple />
<button onclick="upload()">Upload</button>

<div id="status">No uploads</div>

<script type="text/javascript">
  // `upload` iterates through all files selected and invokes a helper function called `retrieveNewURL`.
  function upload() {
    // Get selected files from the input element.
    var files = document.querySelector('#selector').files;
    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      // Retrieve a URL from our server.
      retrieveNewURL(file, (file, url) => {
        // Upload the file to the server.
        uploadFile(file, url);
      });
    }
  }

  // `retrieveNewURL` accepts the name of the current file and invokes the `/presignedUrl` endpoint to
  // generate a pre-signed URL for use in uploading that file:
  function retrieveNewURL(file, cb) {
    fetch(`/presignedUrl?name=${file.name}`)
      .then((response) => {
        response.text().then((url) => {
          cb(file, url);
        });
      })
      .catch((e) => {
        console.error(e);
      });
  }

  // ``uploadFile` accepts the current filename and the pre-signed URL. It then uses `Fetch API`
  // to upload this file to S3 at `play.min.io:9000` using the URL:
  function uploadFile(file, url) {
    if (document.querySelector('#status').innerText === 'No uploads') {
      document.querySelector('#status').innerHTML = '';
    }
    file.name = 'profile-777cc88c-2e3f-4eb4-ac81-14c9323c541d';
    fetch(
      'http://152.206.177.203:9000/saturday.static/profile-777cc88c-2e3f-4eb4-ac81-14c9323c541d?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=minio%2F20211028%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20211028T034440Z&X-Amz-Expires=86400&X-Amz-SignedHeaders=host&X-Amz-Signature=e1704681abba065dc34e36cf05bd5085a7cc5c1dbbdfcb0ed4d37fe8d397afc4',
      {
        method: 'PUT',
        body: file,
      },
    )
      .then(() => {
        // If multiple files are uploaded, append upload status on the next line.
        document.querySelector(
          '#status',
        ).innerHTML += `<br>Uploaded ${file.name}.`;
      })
      .catch((e) => {
        console.error(e);
      });
  }
</script>
